################################################################################
# ðŸ§  POSTGRESQL MASTER DBA INSTALLATION & STORAGE MANAGEMENT - CODE SHEET
# Works on: Linux / WSL (Ubuntu)
# Purpose: End-to-end setup from installation to advanced DBA storage planning
################################################################################

# -------------------------------
# ðŸªœ STEP 1: Update System Packages
# -------------------------------
sudo apt update && sudo apt upgrade -y
# âœ… Updates package lists and upgrades existing system packages to latest versions.

# -------------------------------
# ðŸªœ STEP 2: Install PostgreSQL
# -------------------------------
sudo apt install postgresql postgresql-contrib -y
# âœ… Installs PostgreSQL and additional utilities (like pg_dump, pg_restore, etc.)

# -------------------------------
# ðŸªœ STEP 3: Switch to postgres System User
# -------------------------------
sudo -i -u postgres
# âœ… The postgres user owns the PostgreSQL cluster and data directory.

# -------------------------------
# ðŸªœ STEP 4: Verify PostgreSQL Service & Cluster
# -------------------------------
pg_lsclusters
# âœ… Lists available PostgreSQL clusters on the system.
# Example Output: Version | Cluster | Port | Status | Owner | Data directory
# PostgreSQL automatically creates a cluster during installation.

# -------------------------------
# ðŸªœ STEP 5: Stop Default Cluster (optional)
# -------------------------------
sudo pg_ctlcluster 16 main stop
# âœ… Stops the default cluster (optional if you want to recreate it manually).

# -------------------------------
# ðŸªœ STEP 6: Create a New Cluster Manually (Advanced DBA Step)
# -------------------------------
sudo pg_createcluster 16 bank_cluster --datadir=/data/pgbank
# âœ… Creates a new cluster named "bank_cluster" using PostgreSQL 16 binaries.
# âœ… Data directory will be /data/pgbank (you can change path based on your storage plan).

# -------------------------------
# ðŸªœ STEP 7: Start the New Cluster
# -------------------------------
sudo pg_ctlcluster 16 bank_cluster start
# âœ… Starts your custom cluster.

# -------------------------------
# ðŸªœ STEP 8: Connect to psql (PostgreSQL Command-Line Tool)
# -------------------------------
psql -p 5432 -U postgres
# âœ… Connects to the PostgreSQL server as superuser "postgres" using default port 5432.
# âœ… "psql" is the PostgreSQL interactive shell (CLI client).

# -------------------------------
# ðŸªœ STEP 9: Check Existing Databases
# -------------------------------
\l
# âœ… Lists all databases.
# Use \l+ to also show size and tablespace information.

# -------------------------------
# ðŸªœ STEP 10: Create Tablespace Directories
# -------------------------------
sudo mkdir -p /data/tbs_core
sudo mkdir -p /data/tbs_audit
sudo mkdir -p /data/tbs_archive

# âœ… Creates three separate storage directories for logical separation of data.
# In a bank project, core = transactions, audit = logs, archive = old data.

# -------------------------------
# ðŸªœ STEP 11: Set Permissions on Tablespaces
# -------------------------------
sudo chown -R postgres:postgres /data/tbs_core /data/tbs_audit /data/tbs_archive
# âœ… PostgreSQL service user must own all tablespace directories.

# -------------------------------
# ðŸªœ STEP 12: Create Tablespaces in PostgreSQL
# -------------------------------
psql -U postgres

CREATE TABLESPACE tbs_core LOCATION '/data/tbs_core';
CREATE TABLESPACE tbs_audit LOCATION '/data/tbs_audit';
CREATE TABLESPACE tbs_archive LOCATION '/data/tbs_archive';

-- âœ… Each tablespace is a storage location for database objects (tables, indexes, etc.)
-- âœ… Allows DBAs to distribute data across different disks for performance & management.

# -------------------------------
# ðŸªœ STEP 13: Create Databases Using Tablespaces
# -------------------------------
CREATE DATABASE bank_core WITH TABLESPACE = tbs_core;
CREATE DATABASE bank_audit WITH TABLESPACE = tbs_audit;
CREATE DATABASE bank_archive WITH TABLESPACE = tbs_archive;

-- âœ… Each database now stores its data in its assigned tablespace.

# -------------------------------
# ðŸªœ STEP 14: Connect to a Database
# -------------------------------
\c bank_core
-- âœ… Switch to "bank_core" database.

# -------------------------------
# ðŸªœ STEP 15: Create Schemas for Logical Separation
# -------------------------------
CREATE SCHEMA finance AUTHORIZATION postgres;
CREATE SCHEMA hr AUTHORIZATION postgres;
CREATE SCHEMA reporting AUTHORIZATION postgres;

-- âœ… Schemas group tables logically within a database.

# -------------------------------
# ðŸªœ STEP 16: Create Tables within Schemas
# -------------------------------
CREATE TABLE finance.transactions (
    txn_id SERIAL PRIMARY KEY,
    txn_date TIMESTAMP DEFAULT NOW(),
    amount NUMERIC(12,2),
    description TEXT
) TABLESPACE tbs_core;

CREATE TABLE hr.employees (
    emp_id SERIAL PRIMARY KEY,
    name TEXT,
    department TEXT,
    salary NUMERIC(10,2)
) TABLESPACE tbs_core;

-- âœ… Tables created in schemas, stored in tbs_core.

# -------------------------------
# ðŸªœ STEP 17: Check Tablespace Locations
# -------------------------------
SELECT spcname, pg_tablespace_location(oid) FROM pg_tablespace;

-- âœ… Shows physical path of each tablespace.

# -------------------------------
# ðŸªœ STEP 18: Check Database and Table Sizes
# -------------------------------
\l+
-- âœ… Shows size and tablespace of all databases.

SELECT pg_size_pretty(pg_database_size('bank_core'));
SELECT pg_size_pretty(pg_total_relation_size('finance.transactions'));

-- âœ… Displays human-readable size of databases and tables.

# -------------------------------
# ðŸªœ STEP 19: Apply OS-Level Quota (Advanced)
# -------------------------------
# Exit postgres user shell first
exit

# Apply a 10GB quota limit to the postgres user on /data mount point
sudo setquota -u postgres 0 10240 0 0 /data

# âœ… This restricts postgres user to 10GB disk usage under /data.
# âœ… PostgreSQL itself doesnâ€™t enforce size limits â€” Linux filesystem does.

# -------------------------------
# ðŸªœ STEP 20: Monitor Cluster Health
# -------------------------------
sudo -i -u postgres
psql -c "SELECT datname, pg_size_pretty(pg_database_size(datname)) FROM pg_database;"
# âœ… Lists sizes of all databases for monitoring.

# To check running connections:
psql -c "SELECT datname, usename, client_addr, state FROM pg_stat_activity;"

# -------------------------------
# ðŸªœ STEP 21: Move Tables Between Tablespaces (If Needed)
# -------------------------------
ALTER TABLE finance.transactions SET TABLESPACE tbs_archive;

-- âœ… Physically moves table data to another tablespace.
-- âœ… Useful for archiving old data or performance balancing.

# -------------------------------
# ðŸªœ STEP 22: Backup and Restore (For Later DBA Practice)
# -------------------------------
# Full database backup
pg_dump -U postgres -d bank_core -F c -f /data/backup/bank_core.dump

# Restore into new database
pg_restore -U postgres -d bank_core_restore /data/backup/bank_core.dump

################################################################################
# âœ… DBA MASTER NOTES
################################################################################
# ðŸ”¹ psql â€” PostgreSQL command-line client (used to execute SQL commands)
# ðŸ”¹ pg_dump / pg_restore â€” for backups and restores
# ðŸ”¹ Tablespaces â€” manage physical storage locations
# ðŸ”¹ OS Quotas â€” enforce disk usage limits
# ðŸ”¹ Schemas â€” organize data logically
# ðŸ”¹ Monitoring Views â€” pg_stat_activity, pg_database_size(), pg_stat_user_tables
# ðŸ”¹ Cluster â€” group of databases managed by one PostgreSQL instance
################################################################################
